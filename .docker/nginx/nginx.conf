
#load_module /usr/local/lib/lua/5.4/cjson.so;
#load_module /usr/lib/nginx/modules/ndk_http_module.so;
#load_module /usr/lib/nginx/modules/ngx_http_lua_module.so;

pcre_jit on;

events {
  worker_connections 1024;
}

daemon off;

env HTTP_PORT;

env APP_REDIS_HOST;
env APP_REDIS_PORT;
env APP_REDIS_PASSWORD;

http {
        # zero copy within the kernel
        sendfile on;

        # send packets only if filled
        tcp_nopush on;

        # remove 200ms delay
        tcp_nodelay on;

        # load mime types and set default one
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # write logs to local syslog
        access_log syslog:server=unix:/dev/log,nohostname,facility=local0,severity=notice combined;
        error_log syslog:server=unix:/dev/log,nohostname,facility=local0 warn;

        # temp paths
        proxy_temp_path /tmp/proxy_temp;
        client_body_temp_path /tmp/client_temp;
        fastcgi_temp_path /tmp/fastcgi_temp;
        uwsgi_temp_path /tmp/uwsgi_temp;
        scgi_temp_path /tmp/scgi_temp;

        # close connections in FIN_WAIT1 state
        reset_timedout_connection on;

        # timeouts
        client_body_timeout 12;
        client_header_timeout 12;
        keepalive_timeout 15;
        send_timeout 10;

        # resolvers to use
        resolver 127.0.0.11 8.8.8.8 ipv6=off;

        # lua path and dicts
        lua_package_path "/usr/local/lib/lua/?.lua;;";
        lua_shared_dict whitelist_ip_cache 10m;
        lua_shared_dict whitelist_reverse_cache 10m;
        lua_shared_dict blacklist_ip_cache 10m;
        lua_shared_dict blacklist_reverse_cache 10m;
        lua_shared_dict dnsbl_cache 10m;

        # crowdsec init


        # shared memory zone for limit_req
        limit_req_zone $binary_remote_addr zone=limit:10m rate=20r/s;

        # whitelist or blacklist country


        # list of blocked user agents
        #include /etc/nginx/map-user-agent.conf;

        # zone for proxy_cache


        # custom http confs
        include /http-confs/*.conf;

        # server config(s)
        #include /etc/nginx/server.conf;

        include /etc/nginx/conf.d/default.conf;
}
